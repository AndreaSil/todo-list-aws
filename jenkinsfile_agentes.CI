pipeline {
  agent any
  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    AWS_REGION         = "us-east-1"
    AWS_DEFAULT_REGION = "us-east-1"
    STACK_NAME         = "staging-todo-list-aws"
    SRC_DIR            = "src"
    PYTEST_FILE        = "test/integration/todoApiTest.py"
  }

  stages {

    stage('Get Code') {
      steps {
        deleteDir()
        sh '''
          set -e
          git clone -b develop https://github.com/AndreaSil/todo-list-aws.git .
          git rev-parse --abbrev-ref HEAD
        '''
      }
    }

    stage('Static Test') {
      agent { label 'tests' }
      steps {
        sh '''
          set -e
          python3 -m venv .venv
          . .venv/bin/activate
          pip install --upgrade pip
          pip install flake8 flake8-html bandit
          mkdir -p reports
          flake8 ${SRC_DIR} --format=html --htmldir=reports/flake8 || true
          bandit -r ${SRC_DIR} -f html -o reports/bandit.html || true
        '''
      }
      post {
        always {
          archiveArtifacts artifacts: 'reports/**', fingerprint: true
        }
      }
    }

    stage('Build') {
      steps {
        sh '''#!/bin/bash
          set -e
          export SAM_CLI_TELEMETRY=0
          export AWS_DEFAULT_REGION="${AWS_REGION}"

          sam build --use-container
        '''
      }
    }

    stage('Validate') {
      steps {
        sh '''#!/bin/bash
          set -e
          export AWS_DEFAULT_REGION="${AWS_REGION}"

          # valida el template ORIGINAL o el build (ambos valen)
          sam validate --region "${AWS_REGION}"
        '''
      }
    }

    stage('Deploy') {
      steps {
        sh '''#!/bin/bash
          set -euo pipefail
          export AWS_DEFAULT_REGION="${AWS_REGION}"
          export SAM_CLI_TELEMETRY=0
    
          echo "== Deploy usando samconfig.toml (staging) =="
          sam deploy --config-env staging \
            --region "${AWS_REGION}" \
            --resolve-s3 \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset
    
          echo "== Sacar URL del API (CloudFormation Outputs) =="
          aws cloudformation describe-stacks \
            --stack-name "${STACK_NAME}" \
            --region "${AWS_REGION}" \
            --query "Stacks[0].Outputs[].OutputValue | [?contains(@,'http')]|[0]" \
            --output text > api_url.txt
    
          echo "API_URL=$(cat api_url.txt)"
          test -s api_url.txt

          stash name: 'apiurl', includes: 'api_url.txt'
        '''
      }
      post {
        always {
          archiveArtifacts allowEmptyArchive: true, artifacts: 'api_url.txt', fingerprint: true
        }
      }
    }
    
    stage('Rest Test') {
      agent { label 'tests' }
      steps {
        sh '''#!/bin/bash
          set -e

          API_URL="$(cat api_url.txt)"
          echo "Testing BASE_URL=$API_URL"

          # OJO: el test usa BASE_URL (no API_URL)
          export BASE_URL="$API_URL"

          python3 -m venv .venv-test
          . .venv-test/bin/activate
          pip install --upgrade pip
          pip install pytest requests

          mkdir -p reports
          pytest -q "${PYTEST_FILE}" --junitxml=reports/pytest-integration.xml
        '''
      }
      post {
        always {
          archiveArtifacts allowEmptyArchive: true, artifacts: 'reports/pytest-integration.xml', fingerprint: true
          junit 'reports/pytest-integration.xml'
        }
      }
    }

    stage('Promote') {
      steps {
       withCredentials([usernamePassword(credentialsId: 'github-pat', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
        sh '''#!/bin/bash
          set -euo pipefail
      
          git config user.name  "jenkins"
          git config user.email "jenkins@local"
      
          git remote set-url origin https://github.com/AndreaSil/todo-list-aws.git
          git fetch origin
      
          git checkout master
          git reset --hard origin/master
          git merge --no-ff origin/develop -m "Release: promote develop to master"
      
          TAG="release-${BUILD_NUMBER}"
          git tag -a "$TAG" -m "Release $TAG"
      
          git push https://${GIT_USER}:${GIT_TOKEN}@github.com/AndreaSil/todo-list-aws.git master
          git push https://${GIT_USER}:${GIT_TOKEN}@github.com/AndreaSil/todo-list-aws.git --tags
        '''
      }
      }
    }
  }
}
